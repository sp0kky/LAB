---
# tasks file for useradd
- name: Lookup secret from Azure Key Vault
  hosts: localhost
  gather_facts: false
  connection: local
  collections:
    - azure.azcollection
  vars:
    vault_name: LAB-MIRKO
    secret_name:
      - azuretestuser
      - azusertest
  tasks:
    - name: Get Key Vault by name
      azure_rm_keyvault_info:
        auth_source: env
        resource_group: RG-LAB
        name: LAB-MIRKO
      register: keyvault
    - name: Set key vault URI fact
      set_fact: keyvaulturi="{{ keyvault['keyvaults'][0]['vault_uri'] }}"
    - name: Get secret value
      azure_rm_keyvaultsecret_info:
        vault_uri: "{{ keyvaulturi }}"
        name: "{{ secret_name }}"
      register: kvSecret
    - name: set secret fact
      set_fact: secretValue="{{ kvSecret['secrets'][0]['secret'] }}"
    - name: Output key vault secret
      debug:
        msg="{{ secretValue }}"